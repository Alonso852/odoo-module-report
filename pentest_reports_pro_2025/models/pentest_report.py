# -*- coding: utf-8 -*-
from odoo import models, fields, api


class PentestReport(models.Model):
    _name = 'pentest.report'
    _description = 'Pentest Report'
    _inherit = ['mail.thread', 'mail.activity.mixin']  # Bonus : suivi + activités
    _order = 'create_date DESC'

    name = fields.Char(string='Title', required=True, tracking=True)
    client = fields.Char(string='Client', tracking=True)
    date_created = fields.Datetime(string='Created', default=fields.Datetime.now, readonly=True)
    last_modified = fields.Datetime(string='Last Modified', default=fields.Datetime.now, readonly=True)

    status = fields.Selection([
        ('draft', 'Draft'),
        ('review', 'In Review'),
        ('approved', 'Approved'),
        ('published', 'Published')
    ], string='Status', default='draft', tracking=True)

    confidentiality = fields.Selection([
        ('public', 'Public'),
        ('internal', 'Internal'),
        ('confidential', 'Confidential'),
        ('strictly_confidential', 'Strictly Confidential')
    ], string='Confidentiality', default='internal', tracking=True)

    authors = fields.Many2many(
        'res.users', string='Authors',
        default=lambda self: self.env.user
    )

    version = fields.Integer(string='Version', default=1, readonly=True)

    section_ids = fields.One2many(
        'pentest.section', 'report_id',
        string='Sections',
        copy=True
    )

    attachment_ids = fields.Many2many(
        'ir.attachment',
        compute='_compute_attachments',
        string='Attachments'
    )

    attachment_count = fields.Integer(compute='_compute_attachments', store=False)

    @api.depends('section_ids.image_id')
    def _compute_attachments(self):
        for report in self:
            attachments = report.section_ids.mapped('image_id')
            report.attachment_ids = attachments
            report.attachment_count = len(attachments)

    def write(self, vals):
        # Mise à jour auto de last_modified
        vals['last_modified'] = fields.Datetime.now()

        # Incrémenter la version seulement si contenu modifié
        if any(field in vals for field in ['name', 'client', 'section_ids', 'status', 'confidentiality']):
            vals['version'] = self.version + 1

        return super(PentestReport, self).write(vals)

    def action_export_pdf(self):
        """Génère le PDF professionnel"""
        self.ensure_one()
        return self.env.ref('pentest_reports.action_report_pentest').report_action(self)

    def action_preview(self):
        """Ouvre la prévisualisation web dans une popup"""
        self.ensure_one()
        return {
            'name': f'Preview: {self.name}',
            'type': 'ir.actions.act_window',
            'res_model': 'pentest.report',
            'view_mode': 'form',
            'res_id': self.id,
            'target': 'new',
            'flags': {'hasSidebar': False, 'modal': True},
            'views': [(self.env.ref('pentest_reports.view_pentest_report_preview').id, 'form')],
        }

    @api.model
    def create(self, vals):
        """Optionnel : préfixe automatique du titre"""
        if vals.get('name', '/').startswith('New'):
            vals['name'] = self.env['ir.sequence'].next_by_code('pentest.report') or 'New Report'
        return super().create(vals)

    @api.model
    def import_from_json(self, data):
        """À implémenter plus tard pour sync externe"""
        # TODO: parser le JSON et créer les sections
        pass
