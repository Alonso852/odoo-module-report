from odoo import _, api, fields, models
from odoo.exceptions import ValidationError


class PentestSection(models.Model):
    """Hierarchy of report sections and subsections."""

    _name = "pentest.section"
    _description = "Pentest Report Section"
    _order = "report_id, sequence, id"

    name = fields.Char(
        string="Title",
        required=True,
        translate=True,
        help="Title printed in the report table of contents.",
    )
    description = fields.Html(
        string="Content",
        sanitize=True,
        sanitize_style=True,
        help="Rich text body that explains the findings.",
    )
    sequence = fields.Integer(default=10, help="Order of the section inside its parent.")
    level = fields.Integer(
        compute="_compute_level",
        store=True,
        string="Level",
        recursive=True,
        help="Automatic depth in the hierarchy.",
    )
    number = fields.Char(
        string="Number",
        compute="_compute_number",
        store=True,
        recursive=True,
        help="Human friendly numbering (1., 1.1., â€¦).",
    )
    report_id = fields.Many2one(
        "pentest.report",
        required=True,
        ondelete="cascade",
        index=True,
        string="Report",
    )
    parent_id = fields.Many2one(
        "pentest.section",
        string="Parent Section",
        ondelete="cascade",
        index=True,
        domain="[('report_id', '=', report_id)]",
    )
    child_ids = fields.One2many(
        "pentest.section",
        "parent_id",
        string="Subsections",
    )
    image_1920 = fields.Image(
        string="Image",
        max_width=1920,
        max_height=1920,
        help="Optional illustration displayed under the description.",
    )
    company_id = fields.Many2one(
        related="report_id.company_id",
        store=True,
        string="Company",
        readonly=True,
    )

    @api.depends("parent_id.level")
    def _compute_level(self):
        for section in self:
            section.level = (section.parent_id.level + 1) if section.parent_id else 1

    @api.depends("sequence", "parent_id", "parent_id.sequence", "parent_id.number", "child_ids.sequence")
    def _compute_number(self):
        for report in self.mapped("report_id"):
            report_sections = report.section_ids
            self._assign_numbers(report_sections.filtered(lambda s: not s.parent_id))

    def _assign_numbers(self, sections, prefix=""):
        for index, section in enumerate(sections.sorted("sequence"), start=1):
            current = f"{prefix}{index}"
            section.number = f"{current}."
            if section.child_ids:
                self._assign_numbers(section.child_ids, f"{current}.")

    @api.constrains("parent_id", "report_id")
    def _check_parent_company(self):
        for section in self:
            if section.parent_id and section.parent_id.report_id != section.report_id:
                raise ValidationError(
                    _("The parent section must belong to the same pentest report."),
                )

    @api.model_create_multi
    def create(self, vals_list):
        sections = super().create(vals_list)
        sections.mapped("report_id")._bump_version()
        return sections

    def write(self, vals):
        res = super().write(vals)
        self.mapped("report_id")._bump_version()
        return res

    def unlink(self):
        reports = self.mapped("report_id")
        res = super().unlink()
        reports._bump_version()
        return res
