from odoo import _, api, fields, models
from odoo.exceptions import ValidationError
from odoo.tools import html2plaintext


class PentestSection(models.Model):
    """Hierarchy of report sections and subsections."""

    _name = "pentest.section"
    _description = "Pentest Report Section"
    _order = "report_id, sequence, id"

    name = fields.Char(
        string="Title",
        required=True,
        translate=True,
        help="Title printed in the report table of contents.",
    )
    subtitle = fields.Char(
        string="Subtitle",
        translate=True,
        help="Secondary title that appears under the main heading.",
    )
    description = fields.Html(
        string="Content",
        sanitize=True,
        sanitize_style=True,
        help="Rich text body that explains the findings.",
    )
    sequence = fields.Integer(default=10, help="Order of the section inside its parent.")
    level = fields.Integer(
        compute="_compute_level",
        store=True,
        string="Level",
        help="Automatic depth in the hierarchy.",
    )
    number = fields.Char(
        string="Number",
        compute="_compute_number",
        store=True,
        help="Human friendly numbering (1., 1.1., â€¦).",
    )
    report_id = fields.Many2one(
        "pentest.report",
        required=True,
        ondelete="cascade",
        index=True,
        string="Report",
    )
    parent_id = fields.Many2one(
        "pentest.section",
        string="Parent Section",
        ondelete="cascade",
        index=True,
        domain="[('report_id', '=', report_id)]",
    )
    child_ids = fields.One2many(
        "pentest.section",
        "parent_id",
        string="Subsections",
    )
    image_1920 = fields.Image(
        string="Illustration",
        max_width=1920,
        max_height=1920,
        help="Optional illustration displayed under the description.",
    )
    template_id = fields.Many2one(
        "pentest.section.template",
        string="Template",
        domain="[('active', '=', True)]",
        help="Template prepared by pentest managers to standardize sections.",
    )
    content_requirement = fields.Selection(
        [
            ("flexible", "Flexible"),
            ("text", "Text only"),
            ("image", "Image only"),
            ("text_image", "Text and image"),
        ],
        string="Content Requirement",
        default="flexible",
        help="Controls whether the section must contain text, an image or both.",
    )
    company_id = fields.Many2one(
        related="report_id.company_id",
        store=True,
        string="Company",
        readonly=True,
    )

    @api.depends("parent_id.level")
    def _compute_level(self):
        for section in self:
            section.level = (section.parent_id.level + 1) if section.parent_id else 1

    @api.depends("sequence", "parent_id", "parent_id.sequence", "parent_id.number", "child_ids.sequence")
    def _compute_number(self):
        for report in self.mapped("report_id"):
            report_sections = report.section_ids
            self._assign_numbers(report_sections.filtered(lambda s: not s.parent_id))

    def _assign_numbers(self, sections, prefix=""):
        for index, section in enumerate(sections.sorted("sequence"), start=1):
            current = f"{prefix}{index}"
            section.number = f"{current}."
            if section.child_ids:
                self._assign_numbers(section.child_ids, f"{current}.")

    @api.constrains("parent_id", "report_id")
    def _check_parent_company(self):
        for section in self:
            if section.parent_id and section.parent_id.report_id != section.report_id:
                raise ValidationError(
                    _("The parent section must belong to the same pentest report."),
                )

    @api.model_create_multi
    def create(self, vals_list):
        sections = super().create(vals_list)
        sections.mapped("report_id")._bump_version()
        return sections

    def write(self, vals):
        res = super().write(vals)
        self.mapped("report_id")._bump_version()
        return res

    def unlink(self):
        reports = self.mapped("report_id")
        res = super().unlink()
        reports._bump_version()
        return res

    @api.onchange("template_id")
    def _onchange_template_id(self):
        for section in self:
            template = section.template_id
            if not template:
                continue
            values = {
                "name": template.name,
                "subtitle": template.subtitle,
                "description": template.description,
                "content_requirement": template.content_requirement,
            }
            if template.image_1920:
                values["image_1920"] = template.image_1920
            section.update({k: v for k, v in values.items() if v})

    @api.constrains("content_requirement", "description", "image_1920", "name", "subtitle")
    def _check_content_requirement(self):
        for section in self:
            requirement = section.content_requirement or "flexible"
            if requirement == "flexible":
                continue
            body = html2plaintext(section.description or "").strip()
            has_text = bool(body)
            has_image = bool(section.image_1920)
            if requirement == "text" and not has_text:
                raise ValidationError(
                    _("Section '%s' must contain descriptive text.") % section.name
                )
            if requirement == "image" and not has_image:
                raise ValidationError(
                    _("Section '%s' must contain an illustration.") % section.name
                )
            if requirement == "text_image" and (not has_text or not has_image):
                raise ValidationError(
                    _("Section '%s' must contain both text and an image.") % section.name
                )
