# -*- coding: utf-8 -*-
from odoo import models, fields, api


class PentestSection(models.Model):
    _name = 'pentest.section'
    _description = 'Report Section / Subsection'
    _order = 'report_id, sequence, id'

    name = fields.Char(string="Title", required=True, translate=True)
    description = fields.Html(string="Content", sanitize_style=True)
    sequence = fields.Integer(default=10)
    level = fields.Integer(compute='_compute_level', store=True)
    number = fields.Char(string="Number", compute='_compute_number', store=True)

    report_id = fields.Many2one('pentest.report', required=True, ondelete='cascade', index=True)
    parent_id = fields.Many2one('pentest.section', string="Parent Section", ondelete='cascade', index=True)
    child_ids = fields.One2many('pentest.section', 'parent_id', string="Subsections")

    image_id = fields.Many2one(
        'ir.attachment',
        string="Image",
        domain="[('res_model', '=', 'pentest.section'), ('res_id', '=', id)]"
    )

    # ==================== LEVEL ====================
    @api.depends('parent_id.level')
    def _compute_level(self):
        for section in self:
            if not section.parent_id:
                section.level = 1
            else:
                section.level = section.parent_id.level + 1

    # ==================== NUMBERING ====================
    @api.depends('sequence', 'parent_id.child_ids.sequence', 'parent_id.number')
    def _compute_number(self):
        # On ne recalcule que pour les rapports concernés
        for report in self.mapped('report_id'):
            root_sections = report.section_ids.filtered(lambda s: not s.parent_id)
            # On lance la récursion une seule fois par rapport
            report.section_ids._recursively_set_numbers(root_sections)

    @api.model
    def _recursively_set_numbers(self, sections, prefix=""):
        """Méthode séparée pour éviter les dépendances circulaires"""
        for idx, section in enumerate(sections.sorted('sequence'), 1):
            new_number = f"{prefix}{idx}" if prefix else str(idx)
            section.number = f"{new_number}."
            if section.child_ids:
                section.child_ids._recursively_set_numbers(section.child_ids, f"{new_number}.")
