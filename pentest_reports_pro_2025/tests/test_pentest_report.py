# Copyright 2024 MGeek
# License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl-3.0.txt)

from odoo.exceptions import ValidationError
from odoo.tests import TransactionCase, tagged


@tagged('-at_install', 'post_install')
class TestPentestReport(TransactionCase):
    """Ensure the pentest workflow behaves as expected."""

    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        cls.report_model = cls.env['pentest.report']
        cls.section_model = cls.env['pentest.section']
        cls.template_model = cls.env['pentest.section.template']
        cls.partner = cls.env['res.partner'].create({'name': 'Demo Client'})
        cls.report = cls.report_model.create({
            'name': 'Demo Pentest',
            'client': cls.partner.name,
            'authors': [(4, cls.env.user.id)],
            'section_ids': [(0, 0, {
                'name': 'Executive Summary',
                'description': '<p>Summary</p>',
                'sequence': 1,
                'child_ids': [(0, 0, {
                    'name': 'Risk Overview',
                    'sequence': 1,
                })],
            })],
        })

    def test_section_numbering(self):
        sections = self.report.section_ids.sorted('sequence')
        self.assertEqual(sections[0].number, '1.', 'Root sections must start at 1.')
        child = sections[0].child_ids[0]
        self.assertEqual(child.number, '1.1.', 'Child numbering should be nested.')

    def test_version_increment(self):
        original_version = self.report.version
        self.report.write({'client': 'Updated Client'})
        self.assertEqual(self.report.version, original_version + 1)

    def test_preview_action(self):
        action = self.report.action_preview()
        self.assertEqual(action['report_type'], 'qweb-html')
        self.assertEqual(action['res_id'], self.report.id)

    def test_sections_action_domain(self):
        action = self.report.action_view_sections()
        self.assertIn(('report_id', '=', self.report.id), action['domain'])

    def test_media_section_counter(self):
        self.report.section_ids[0].image_1920 = 'dGVzdA=='
        self.report._compute_section_metrics()
        self.assertEqual(self.report.media_section_count, 1)

    def test_section_template_onchange(self):
        template = self.template_model.create({
            'name': 'Template title',
            'subtitle': 'Template subtitle',
            'description': '<p>Body</p>',
            'content_requirement': 'text',
        })
        section = self.section_model.new({'report_id': self.report.id})
        section.template_id = template
        section._onchange_template_id()
        self.assertEqual(section.name, template.name)
        self.assertEqual(section.subtitle, template.subtitle)

    def test_content_requirement_validation(self):
        with self.assertRaises(ValidationError):
            self.section_model.create({
                'report_id': self.report.id,
                'name': 'Image only',
                'content_requirement': 'image',
            })
